<div class="user-details-page">
  @if (user(); as currentUser) {
    <div class="details-layout">
      <mat-card class="content-card main-info-card">
        <div class="user-header">
          <div class="user-photo-wrapper">
            @if (getAvatarUrl(); as avatar) {
              <img class="user-photo-main" [src]="avatar" [alt]="currentUser.firstName" />
            } @else {
              <div class="user-photo-placeholder">
                <mat-icon>person</mat-icon>
              </div>
            }
          </div>

          <div class="user-main-text">
            <h2 class="user-name">
              {{ currentUser.firstName }}
            </h2>

            <mat-chip-set>
              <mat-chip class="info-chip">
                <mat-icon>elderly</mat-icon>
                <span>wiek: {{ getAge(currentUser.dateOfBirth) }}</span>
              </mat-chip>
            </mat-chip-set>
          </div>
        </div>

        @if (userPets().length > 0) {
          <mat-divider></mat-divider>
          <div class="user-pets-section">
            <h3>Moje psy</h3>
            <div class="pets-list">
              @for (pet of userPets(); track pet.dogId) {
                <div class="pet-card-mini" [routerLink]="['/pets', pet.dogId]">
                  <img [src]="pet.photos[0].url" [alt]="pet.name" class="pet-mini-photo" />
                  <div class="pet-mini-info">
                    <span class="pet-name">{{ pet.name }}</span>
                    <span class="pet-details">{{ pet.breed.name }}, {{ pet.weightKg }}kg</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </mat-card>

      <div class="right-column">
        <mat-card class="content-card reviews-card">
          <div class="reviews-title-row">
            <h3>Opinie ({{ reviews().length }})</h3>
            <div class="rating-badge">
              <mat-icon>star</mat-icon>
              {{ score() }}
            </div>
          </div>

          <form [formGroup]="reviewForm" (ngSubmit)="onSubmitReview()" class="review-form">
            <div class="rating-input-container">
              <span>Twoja ocena:</span>

              <div class="interactive-stars" (mouseleave)="onStarLeave()">
                @for (star of stars; track star) {
                  <mat-icon
                    class="star-btn"
                    [class.active]="
                      (hoverRating() ?? reviewForm.controls.rating.value) >= star - 0.5
                    "
                    (mousemove)="onStarHover($event, star)"
                    (click)="onStarClick()"
                  >
                    {{ getStarIcon(star) }}
                  </mat-icon>
                }

                <span class="rating-value-label">
                  {{ hoverRating() ?? reviewForm.controls.rating.value }} / 5
                </span>
              </div>

              <input type="hidden" formControlName="rating" />
            </div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Dodaj opiniÄ™ o uÅ¼ytkowniku</mat-label>
              <textarea
                matInput
                rows="3"
                formControlName="text"
                placeholder="Jak przebiegÅ‚ spacer?..."
              ></textarea>
              @if (textControl.touched && textControl.invalid) {
                <mat-error>TreÅ›Ä‡ opinii jest wymagana.</mat-error>
              }
            </mat-form-field>

            <div class="form-footer">
              <span class="hint">ðŸ’¡ Twoja opinia bÄ™dzie widoczna dla wszystkich uÅ¼ytkownikÃ³w</span>
              <button matButton="filled" type="submit" [disabled]="reviewForm.invalid">
                Dodaj opiniÄ™
              </button>
            </div>
          </form>
          <div class="reviews-list-container">
            @for (review of reviews(); track review.id; let last = $last) {
              <div class="review-row">
                <div class="review-content-wrapper">
                  <div class="review-main-content">
                    <div class="review-header">
                      <span class="author">{{ review.author }}</span>
                      <span class="date">{{ review.createdAt | date: 'shortDate' }}</span>

                      <div class="star-rating-display">
                        @for (i of [1, 2, 3, 4, 5]; track i) {
                          <mat-icon class="star-icon-small">
                            {{ getRatingForReview(review.rating, i) }}
                          </mat-icon>
                        }
                      </div>
                    </div>

                    <p class="text">{{ review.text }}</p>
                  </div>

                  <button
                    mat-icon-button
                    matTooltip="ZgÅ‚oÅ› opiniÄ™"
                    (click)="onReportReview(review.id)"
                    [disabled]="review.reported"
                    class="report-btn"
                  >
                    <mat-icon [class.reported]="review.reported">flag</mat-icon>
                  </button>
                </div>
              </div>

              @if (!last) {
                <mat-divider></mat-divider>
              }
            }
          </div>
        </mat-card>
      </div>
    </div>
  }
</div>
